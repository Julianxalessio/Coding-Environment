<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="CloseButton.css">
    <link rel="stylesheet" href="LoginSite.css">
    <link rel="stylesheet" href="Classes.css">
    <title>Coding-Environment</title>
    <style>
        textarea {
            width: 30%;
            height: 100%;
            font-size: 1.3em;
        }

        #InputScript {
            width: 50%;
        }

        .Container {
            position: fixed;
            top: 0;
            left: 2px;
            width: 100%;
            height: 99%;
            display: flex;
            gap: 5px;
        }

        .UserName {
            width: 100%;
            border-radius: 10px;
            height: min-content;
            border: solid 1px black;
            text-align: center;
            font-size: 1.5em;
            cursor: pointer;
            color: black;
            background-color: white;
            margin: 5px 0 10px 0;
        }

        .UserName:hover {
            background-color: black;
            color: white;
        }

        .FilesContainer {
            flex-grow: 1;
            height: auto;
            border-radius: 10px;
            border: solid 1px black;
            overflow-y: auto;
        }

        .NewFileBtn {
            height: 30px;
            width: 30px;
            font-size: 1.1em;
            background-color: white;
            border-color: black;
            border-radius: 8px;
            margin: 5px;
        }

        .NewFileBtn:hover {
            background-color: rgb(65, 64, 64);
            color: white;
        }

        .NewFileNameInput {
            font-size: 1.1em;
            width: calc(100% - 60px);
        }

        .File {
            border: solid 1px black;
            border-radius: 5px;
            margin: 5px;
            padding: 4px;
            height: auto;
            min-height: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .FileName {
            font-size: 1.1em;
            margin: 0;
        }

        .RightSide {
            display: flex;
            flex-direction: column;
            margin-right: 5px;
        }

        .Buttons {
            margin-top: 10px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .Buttons button {
            background-color: white;
            height: 40px;
            width: 100%;
            font-size: 1em;
            border-color: black;
            border-radius: 8px;
        }

        .Buttons button:hover {
            background-color: rgb(65, 64, 64);
            color: white;
        }

        .FileHitbox {
            border-radius: 5px;
            height: auto;
            min-height: 30px;
            cursor: pointer;
            width: 100%;
        }
    </style>
</head>

<body>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, set, get, child, remove, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";        

        const firebaseConfig = {
            apiKey: "AIzaSyChvPU8blLsvMTUq5LO0dDewMiDzZhVx4M",
            authDomain: "coding-environment-1df0d.firebaseapp.com",
            databaseURL: "https://coding-environment-1df0d-default-rtdb.firebaseio.com/",
            projectId: "coding-environment-1df0d",
            storageBucket: "coding-environment-1df0d.firebasestorage.app",
            messagingSenderId: "500351380812",
            appId: "1:500351380812:web:48e77ef8e5a46dc5b0b3e9",
            measurementId: "G-FMDTP8GK8X"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.creatUser = function (UserName, password) {
            const dbRef = ref(db, `users/${UserName}`);
            set(dbRef, {
                Password: password
            }).then(() => {
                console.log("User created!");
                LoginedUser = UserName;
                document.getElementById("UserName").innerHTML = UserName;
                OpenLoginSite();
                const FilesContainer = document.getElementById("FilesContainer2");
                FilesContainer.innerHTML = "";
            }).catch((error) => {
                console.error("Fehler beim Speichern:", error);
            });
        };

        window.SaveFileToFirebase = function () {
            if (!LoginedUser) {
                alert("Not logged in");
                return;
            }
            if (!ActiveFile) {
                alert("No file selected or created!");
                return;
            }
            const UserName = LoginedUser;
            const FileName = ActiveFile;
            const FileContent = document.getElementById("InputScript").value;
            const dbRef = ref(db, `users/${UserName}/Files/${FileName}`);

            if (UserName == "" || FileName == ""){
                alert("Error")
            }
            else{
                set(dbRef, {
                    Content: FileContent
                }).then(() => {
                    console.log("File saved!");
                }).catch((error) => {
                    console.error("Fehler beim Speichern:", error);
                });
            }
        };
        
        window.CreateFileOnFirebase = function (FileName) {
            if (!LoginedUser) {
                alert("Not logged in");
                return;
            }

            const UserName = LoginedUser;
            const FileContent = document.getElementById("InputScript").value;
            const dbRef = ref(db, `users/${UserName}/Files/${FileName}`);

            if (UserName == "" || FileName == ""){
                alert("Error")
            }
            else{
                set(dbRef, {
                    Content: FileContent
                }).then(() => {
                    console.log("File saved!");
                }).catch((error) => {
                    console.error("Fehler beim Speichern:", error);
                });
            }
            };
        
        window.LoadFiles = function () {
            const db = getDatabase();
            const UserName = LoginedUser;
            const filesRef = ref(db, `users/${UserName}/Files`);

            onValue(filesRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                Object.keys(data).forEach(fileName => {
                    const file = data[fileName];                
                    CreateFileFromFirebase(fileName, file.Content);
                });
            } else {
                console.log("Keine Dateien gefunden.");
            }
        });
        }

        window.login = function (InputUser, InputPassword) {
            get(child(ref(db), `users/${InputUser}/Password`))
                .then((snapshot) => {
                if (snapshot.exists()) {
                    const password = snapshot.val();
                    if (InputPassword == password){
                        LoginedUser = InputUser;
                        document.getElementById("UserName").innerHTML = InputUser;
                        const FilesContainer = document.getElementById("FilesContainer2");
                        FilesContainer.innerHTML = "";
                        OpenLoginSite();
                        LoadFiles();
                        
                    }
                    else{
                        alert("Wrong Password");
                    }
                } else {
                    alert("Benutzer nicht gefunden");
                }
                })
            .catch((error) => {
                console.error("Fehler beim Abrufen:", error);
            });
        };
        
        window.RemoveFile = function (FileName){
            const UserName = LoginedUser;
            let pathToDelete = `users/${UserName}/Files/${FileName}`
            remove(ref(db, pathToDelete))
            .then(() => {
                console.log("Daten erfolgreich gelöscht.");
            })
            .catch((error) => {
                console.error("Fehler beim Löschen:", error);
            })
        }
    </script>
    <div class="Container">
        <textarea id="InputScript" placeholder="Code:"></textarea>
        <textarea readonly id="Output" placeholder="Output:"></textarea>
        <div class="RightSide">
            <h3 id="UserName" class="UserName" onclick="OpenLoginSite()">Login</h3>
            <div class="FilesContainer">
                <button class="NewFileBtn" onclick="CreateFile()">+</button>
                <input id="FileNameInput" class="NewFileNameInput" type="text" placeholder="Name:">
                <div id="FilesContainer2"></div>
            </div>
            <div class="Buttons">
                <button onclick="SaveFile()" id="SaveBtn">Save</button>
                <button onclick="RunCode()" id="RunButton">Run</button>
            </div>
        </div>
    </div>
    <div id="LoginSite" class="None">
        <div id="LoginContainer">
            <h3>Login</h3>
            <input type="text" placeholder="Username" id="LoginInputName">
            <input type="password" placeholder="Passwort" id="LoginInputPassword">
            <button onclick="togglePasswordLogin()" id="TogglePasswordButtonLogin">
                <svg id="ToggleIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none"
                    stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8
                a17.92 17.92 0 0 1 5.06-5.94M1 1l22 22" />
                    <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" />
                    <line x1="3" y1="3" x2="21" y2="21" />
                </svg>
            </button>
            <button id="LoginButton" onclick="loginEntered()">Login</button>
        </div>
        <div id="RegisterContainer">
            <h3>Register</h3>
            <input type="text" placeholder="Username" id="RegisterInputName">
            <input type="password" id="RegisterInputPassword" placeholder="Passwort">
            <button onclick="togglePasswordRegister()" id="TogglePasswordButtonRegister">
                <svg id="ToggleIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none"
                    stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8
                a17.92 17.92 0 0 1 5.06-5.94M1 1l22 22" />
                    <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" />
                    <line x1="3" y1="3" x2="21" y2="21" />
                </svg>
            </button>
            <button id="RegisterButton" onclick="registerEntered()">Register</button>
        </div>
        <h2 onclick="OpenLoginSite()" id="CloseButton">X</h2>
    </div>
    <script>
        // ============================= Variables ============================
        let LoginedUser;
        let Login = false;
        let ActiveFile;
        let Files = {};

        // ============================= EventListeners ============================

        LoginContainer.addEventListener('keypress', function (e) {
            if (e.key === "Enter") {
                loginEntered();
            }
        });

        RegisterContainer.addEventListener('keypress', function (e) {
            if (e.key === "Enter") {
                registerEntered();
            }
        });

        FileNameInput.addEventListener('keypress', function (e) {
            if (e.key === "Enter") {
                CreateFile();
            }
        });

        window.addEventListener('beforeunload', function (e) {
            // Nachricht für den Benutzer (wird in modernen Browsern oft ignoriert oder ersetzt)
            const confirmationMessage =
                "Bist du sicher, dass du die Seite verlassen möchtest? Nicht gespeicherte Daten könnten verloren gehen.";

            // Standardaktion verhindern
            e.preventDefault();

            // Manche Browser benötigen diese Zuweisung, um den Dialog anzuzeigen
            e.returnValue = confirmationMessage;

            // Für ältere Browser
            return confirmationMessage;
        });

        // ============================= Other Functions ============================    
        function SaveFile() {
            const UserName = LoginedUser;
            const FileName = ActiveFile;
            const FileContent = document.getElementById("InputScript").value;
            if (FileName == undefined) {
                alert("No file selected");
            } else {
                Files[FileName] = FileContent;
                SaveFileToFirebase()
                alert("Sucessfuly saved");
            }
        }

        function CreateFileFromFirebase(Name, Content) {
            if (LoginedUser == null) {
                //alert("Not loged in")
            } else {
                // Prevent duplicate file divs
                if (document.getElementById(Name)) return;

                const FilesContainer = document.getElementById("FilesContainer2");

                let newFileDiv = document.createElement("div");
                newFileDiv.className = "File";
                newFileDiv.id = Name;

                let newFileName = document.createElement("h4");
                newFileName.className = "FileName";
                newFileName.textContent = Name;

                let newFileHitbox = document.createElement("div");
                newFileHitbox.className = "FileHitbox"
                newFileHitbox.setAttribute("onclick", "LoadFileContent(this)")

                let deleteBtn = document.createElement("button");
                deleteBtn.className = "btn btn-delete";
                deleteBtn.innerHTML = `<span class="mdi mdi-delete"></span> <span>Delete</span>`;
                deleteBtn.onclick = function () {
                    newFileDiv.remove();
                    delete Files[Name];
                    RemoveFile(Name);
                };

                newFileDiv.appendChild(newFileHitbox);
                newFileHitbox.appendChild(newFileName);
                newFileDiv.appendChild(deleteBtn);

                document.querySelector(".NewFileNameInput").value = "";

                FilesContainer.appendChild(newFileDiv);
                Files[Name] = Content;
            }
        }

        function CreateFile() {
            let Name = document.querySelector(".NewFileNameInput").value;
            if (Name == "") {
                alert("Insert a name for the file");
            } else {
                if (LoginedUser == null) {
                    //alert("Not loged in")
                } else {
                    const fileExists = Object.keys(Files).some(key => key.toLowerCase() === Name.toLowerCase());
                    if (!fileExists) {
                        const FilesContainer = document.getElementById("FilesContainer2");

                        let newFileDiv = document.createElement("div");
                        newFileDiv.className = "File";
                        newFileDiv.id = Name;

                        let newFileName = document.createElement("h4");
                        newFileName.className = "FileName";
                        newFileName.textContent = Name;

                        let newFileHitbox = document.createElement("div");
                        newFileHitbox.className = "FileHitbox"
                        newFileHitbox.setAttribute("onclick", "LoadFileContent(this)")

                        let deleteBtn = document.createElement("button");
                        deleteBtn.className = "btn btn-delete";
                        deleteBtn.innerHTML = `<span class="mdi mdi-delete"></span> <span>Delete</span>`;
                        deleteBtn.onclick = function () {
                            newFileDiv.remove();
                            delete Files[Name];
                            RemoveFile(Name);
                        };

                        newFileDiv.appendChild(newFileHitbox);
                        newFileHitbox.appendChild(newFileName);
                        newFileDiv.appendChild(deleteBtn);

                        document.querySelector(".NewFileNameInput").value = "";

                        FilesContainer.appendChild(newFileDiv);
                        Files[Name] = "";
                        CreateFileOnFirebase(Name);
                    } else {
                        alert("File with that name already exists");
                    }
                }
            }
        }

        function LoadFileContent(Parent) {
            const FileName = Parent.parentElement.id;
            if (ActiveFile != FileName) {
                if (ActiveFile != undefined) {
                    let ContentOfActiveFile = Files[ActiveFile];
                    let ContentOfInput = document.getElementById("InputScript").value;
                    if (ContentOfActiveFile != ContentOfInput) {
                        let Antwort = confirm("Do you want to continue without saving?");
                        if (Antwort == false) {
                            return
                        } else {
                            let Content = Files[FileName];
                            document.getElementById("InputScript").value = Content;
                            const AllFiles = document.querySelectorAll(".File");
                            AllFiles.forEach(element => {
                                element.classList.remove("active");
                            });
                            document.getElementById(FileName).className = "File active";
                            ActiveFile = FileName;
                        }
                    } else {
                        let Content = Files[FileName];
                        document.getElementById("InputScript").value = Content;
                        const AllFiles = document.querySelectorAll(".File");
                        AllFiles.forEach(element => {
                            element.classList.remove("active");
                        });
                        document.getElementById(FileName).className = "File active";
                        ActiveFile = FileName;
                    }
                } else {
                    let Content = Files[FileName];
                    document.getElementById("InputScript").value = Content;
                    const AllFiles = document.querySelectorAll(".File");
                    AllFiles.forEach(element => {
                        element.classList.remove("active");
                    });
                    document.getElementById(FileName).className = "File active";
                    ActiveFile = FileName;
                }
            }
        }
    </script>
    <script src="LoginFunctions.js"></script>
    <script src="Jal.js"></script>
</body>

</html>
