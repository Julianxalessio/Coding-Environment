<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="CSS/CloseButton.css">
    <link rel="stylesheet" href="CSS/style.css">
    <link rel="stylesheet" href="CSS/Classes.css">
    <title>Coding-Environment</title>
</head>

<body>
    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import {
            getDatabase,
            ref,
            set,
            get,
            child,
            remove,
            onValue
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyChvPU8blLsvMTUq5LO0dDewMiDzZhVx4M",
            authDomain: "coding-environment-1df0d.firebaseapp.com",
            databaseURL: "https://coding-environment-1df0d-default-rtdb.firebaseio.com/",
            projectId: "coding-environment-1df0d",
            storageBucket: "coding-environment-1df0d.firebasestorage.app",
            messagingSenderId: "500351380812",
            appId: "1:500351380812:web:48e77ef8e5a46dc5b0b3e9",
            measurementId: "G-FMDTP8GK8X"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ensure globals used by non-module scripts and inline handlers exist
        window.LoginedUser = window.LoginedUser || "";
        window.ActiveFile = window.ActiveFile || undefined;
        window.Files = window.Files || {};

        window.creatUser = function (UserName, password) {
            const dbRef = ref(db, `users/${UserName}`);
            set(dbRef, {
                Password: password
            }).then(() => {
                console.log("User created!");
                window.LoginedUser = UserName;
                document.getElementById("UserName").innerHTML = UserName;
                OpenLoginSite();
                const FilesContainer = document.getElementById("FilesContainer2");
                FilesContainer.innerHTML = "";
            }).catch((error) => {
                console.error("Fehler beim Speichern:", error);
            });
        };

        function SaveFile() {
            const UserName = window.LoginedUser;
            const FileName = window.ActiveFile;
            const FileContent = document.getElementById("editor").value; // <- use editor
            if (FileName == undefined) {
                alert("No file selected");
            } else {
                window.Files[FileName] = FileContent;
                SaveFileToFirebase()
                alert("Sucessfuly saved");
            }
        }

        window.SaveFileToFirebase = function () {
            if (!window.LoginedUser) {
                alert("Not logged in");
                return;
            }
            if (!window.ActiveFile) {
                alert("No file selected or created!");
                return;
            }
            const UserName = window.LoginedUser;
            const FileName = window.ActiveFile;
            const FileContent = document.getElementById("editor").value; // <- use editor
            const dbRef = ref(db, `users/${UserName}/Files/${FileName}`);

            if (UserName == "" || FileName == "") {
                alert("Error")
            } else {
                set(dbRef, {
                    Content: FileContent
                }).then(() => {
                    console.log("File saved!");
                }).catch((error) => {
                    console.error("Fehler beim Speichern:", error);
                });
            }
        };

        window.CreateFileOnFirebase = function (FileName) {
            if (!window.LoginedUser) {
                alert("Not logged in");
                return;
            }

            const UserName = window.LoginedUser;
            const FileContent = document.getElementById("editor").value; // <- use editor
            const dbRef = ref(db, `users/${UserName}/Files/${FileName}`);

            if (UserName == "" || FileName == "") {
                alert("Error")
            } else {
                set(dbRef, {
                    Content: FileContent
                }).then(() => {
                    console.log("File saved!");
                }).catch((error) => {
                    console.error("Fehler beim Speichern:", error);
                });
            }
        };

        window.LoadFiles = function () {
            const db = getDatabase();
            const UserName = window.LoginedUser;
            const filesRef = ref(db, `users/${UserName}/Files`);

            onValue(filesRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(fileName => {
                        const file = data[fileName];
                        CreateFileFromFirebase(fileName, file.Content);
                    });
                } else {
                    console.log("Keine Dateien gefunden.");
                }
            });
        }

        window.login = function (InputUser, InputPassword) {
            get(child(ref(db), `users/${InputUser}/Password`))
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const password = snapshot.val();
                        if (InputPassword == password) {
                            window.LoginedUser = InputUser;
                            document.getElementById("UserName").innerHTML = InputUser;
                            const FilesContainer = document.getElementById("FilesContainer2");
                            FilesContainer.innerHTML = "";
                            OpenLoginSite();
                            LoadFiles();

                        } else {
                            alert("Wrong Password");
                        }
                    } else {
                        alert("Benutzer nicht gefunden");
                    }
                })
                .catch((error) => {
                    console.error("Fehler beim Abrufen:", error);
                });
        };

        window.RemoveFile = function (FileName) {
            const UserName = window.LoginedUser;
            let pathToDelete = `users/${UserName}/Files/${FileName}`
            remove(ref(db, pathToDelete))
                .then(() => {
                    console.log("Daten erfolgreich gelöscht.");
                })
                .catch((error) => {
                    console.error("Fehler beim Löschen:", error);
                })
        }

        function LoadFileContent(Parent) {
            const FileName = Parent.parentElement.id;
            if (window.ActiveFile != FileName) {
                if (window.ActiveFile != undefined) {
                    let ContentOfActiveFile = window.Files[window.ActiveFile];
                    let ContentOfInput = document.getElementById("editor").value; // <- use editor
                    if (ContentOfActiveFile != ContentOfInput) {
                        let Antwort = confirm("Do you want to continue without saving?");
                        if (Antwort == false) {
                            return
                        } else {
                            let Content = window.Files[FileName];
                            const editorEl = document.getElementById("editor");
                            editorEl.value = Content; // set editor value
                            editorEl.dispatchEvent(new Event('input')); // refresh highlight
                            const AllFiles = document.querySelectorAll(".File");
                            AllFiles.forEach(element => {
                                element.classList.remove("active");
                            });
                            document.getElementById(FileName).className = "File active";
                            window.ActiveFile = FileName;
                        }
                    } else {
                        let Content = window.Files[FileName];
                        const editorEl = document.getElementById("editor");
                        editorEl.value = Content; // set editor value
                        editorEl.dispatchEvent(new Event('input')); // refresh highlight
                        const AllFiles = document.querySelectorAll(".File");
                        AllFiles.forEach(element => {
                            element.classList.remove("active");
                        });
                        document.getElementById(FileName).className = "File active";
                        window.ActiveFile = FileName;
                    }
                } else {
                    let Content = window.Files[FileName];
                    const editorEl = document.getElementById("editor");
                    editorEl.value = Content; // set editor value
                    editorEl.dispatchEvent(new Event('input')); // refresh highlight
                    const AllFiles = document.querySelectorAll(".File");
                    AllFiles.forEach(element => {
                        element.classList.remove("active");
                    });
                    document.getElementById(FileName).className = "File active";
                    window.ActiveFile = FileName;
                }
            }
        }

    </script>
    <div class="Container">
        <div class="LeftSide">
            <div class="code-editor">
                <pre class="highlight" aria-hidden="true"><code id="highlight"></code></pre>
                <textarea id="editor" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"
                    placeholder="Type code here..."></textarea>
            </div>
            <textarea readonly id="Output" placeholder="Output:"></textarea>
        </div>
        <div class="RightSide">
            <h3 id="UserName" class="UserName" onclick="OpenLoginSite()">Login</h3>
            <div class="FilesContainer">
                <button class="NewFileBtn" onclick="CreateFile()">Create</button>
                <input id="FileNameInput" class="NewFileNameInput" type="text" placeholder="Name:">
                <div id="FilesContainer2"></div>
            </div>
            <div class="Buttons">
                <div class="template-insert">
                    <select name="codeTemplates" id="codeTemplates">
                        <option value="if">If Block (incase)</option>
                        <option value="during">During Loop</option>
                        <option value="func">Function Definition</option>
                        <option value="set">Set Variable</option>
                        <option value="write">Write Output</option>
                        <option value="call">Call Function</option>
                        <option value="reset">Redefine Variable</option>
                        <option value="connect">Connect File</option>
                        <option value="comment">Add Comment</option>
                        <option value="wait">Wait/Pause</option>
                        <option value="input">Input Variable</option>
                        <option value="random">Random Number</option>
                    </select>
                    <button onclick="insertTemplate()">Insert</button>
                </div>
                <button onclick="SaveFile()" id="SaveBtn">Save</button>
                <button id="RunButton">Run</button>
            </div>
        </div>
    </div>
    <div id="LoginSite" class="None">
        <div id="LoginContainer">
            <h3>Login</h3> <input type="text" placeholder="Username" id="LoginInputName"> <input type="password"
                placeholder="Passwort" id="LoginInputPassword"> <button onclick="togglePasswordLogin()"
                id="TogglePasswordButtonLogin"> <svg id="ToggleIcon" xmlns="http://www.w3.org/2000/svg" width="20"
                    height="20" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    viewBox="0 0 24 24">
                    <path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8 a17.92 17.92 0 0 1 5.06-5.94M1 1l22 22" />
                    <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" />
                    <line x1="3" y1="3" x2="21" y2="21" /> </svg> </button> <button id="LoginButton"
                onclick="loginEntered()">Login</button>
        </div>
        <div id="RegisterContainer">
            <h3>Register</h3> <input type="text" placeholder="Username" id="RegisterInputName"> <input type="password"
                id="RegisterInputPassword" placeholder="Passwort"> <button onclick="togglePasswordRegister()"
                id="TogglePasswordButtonRegister"> <svg id="ToggleIcon" xmlns="http://www.w3.org/2000/svg" width="20"
                    height="20" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    viewBox="0 0 24 24">
                    <path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8 a17.92 17.92 0 0 1 5.06-5.94M1 1l22 22" />
                    <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" />
                    <line x1="3" y1="3" x2="21" y2="21" /> </svg> </button> <button id="RegisterButton"
                onclick="registerEntered()">Register</button>
        </div>
        <h2 onclick="OpenLoginSite()" id="CloseButton">X</h2>
    </div>

    <link rel="stylesheet" href="CSS/highlighter.css">

    <script>
    (function initHighlighter(){
      function start() {
        const editor = document.getElementById('editor');
        const highlight = document.getElementById('highlight');
        if (!editor || !highlight) return; // nothing to do

        const keywords = ['set','write','incase','func','call','connect','hallo'];
        const kwPattern = '\\b(' + keywords.join('|') + ')\\b';
        const regex = new RegExp(
          [
            /("([^"\\]|\\.)*")/.source,        // double-quoted strings
            /(\/\/.*$)/.source,                // line comments
            kwPattern                          // keywords
          ].join('|'),
          'gm'
        );

        function escapeHtml(str) {
          return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }

        function highlightCode(text) {
          let escaped = escapeHtml(text);
          return escaped.replace(regex, (match, str, _1, comment, kw) => {
            if (str !== undefined) return '<span class="token string">' + escapeHtml(str) + '</span>';
            if (comment !== undefined) return '<span class="token comment">' + escapeHtml(comment) + '</span>';
            if (kw !== undefined) return '<span class="token keyword">' + escapeHtml(kw) + '</span>';
            return match;
          }).replace(/\n/g, '<br>').replace(/ {2}/g, '&nbsp;&nbsp;');
        }

        function syncScroll() {
          highlight.parentElement.scrollTop = editor.scrollTop;
          highlight.parentElement.scrollLeft = editor.scrollLeft;
        }

        function update() {
          const text = editor.value || '';
          highlight.innerHTML = '<code>' + highlightCode(text) + '</code>';
          syncScroll();
        }

        editor.addEventListener('input', update);
        editor.addEventListener('scroll', syncScroll);

        // initialize now (and again after includes if needed)
        update();

        // if fragments change editor content later, call update() after setting editor.value
        window.updateHighlighter = update;
      }

      // wait for DOMContentLoaded to ensure includeFragments has run
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', start);
      } else {
        start();
      }
    })();
    </script>

    <script>
        const eyeSVG = `
            <svg id="ToggleIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none"
            stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            viewBox="0 0 24 24">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
            <circle cx="12" cy="12" r="3" />
            </svg>
        `;

        const eyeOffSVG = `
            <svg id="ToggleIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none"
            stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            viewBox="0 0 24 24">
            <path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8
                    a17.92 17.92 0 0 1 5.06-5.94M1 1l22 22" />
            <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" />
            <line x1="3" y1="3" x2="21" y2="21" />
            </svg>
            `;

        function togglePasswordRegister() {
            const input = document.getElementById("RegisterInputPassword");
            const button = document.getElementById("TogglePasswordButtonRegister");

            if (input.type === "password") {
                input.type = "text";
                button.innerHTML = eyeSVG;
            } else {
                input.type = "password";
                button.innerHTML = eyeOffSVG;
            }
        }

        function togglePasswordLogin() {
            const input = document.getElementById("LoginInputPassword");
            const button = document.getElementById("TogglePasswordButtonLogin");

            if (input.type === "password") {
                input.type = "text";
                button.innerHTML = eyeSVG;
            } else {
                input.type = "password";
                button.innerHTML = eyeOffSVG;
            }
        }

        function loginEntered() {
            UserName = document.getElementById("LoginInputName").value;
            Password = document.getElementById("LoginInputPassword").value;
            login(UserName, Password);
        }

        function registerEntered() {
            UserName = document.getElementById("RegisterInputName").value;
            Password = document.getElementById("RegisterInputPassword").value;
            creatUser(UserName, Password);
        }

        function OpenLoginSite() {
                    document.getElementById("LoginSite").classList.toggle("None");
        }
    </script>
    <script src="JS/Jal.js"></script>
</body>

</html>